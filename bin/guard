#!/usr/bin/env ruby

require "pathname"

default = Pathname(ENV.fetch("BUNDLE_GEMFILE", "Gemfile"))
relative_to_binstub = Pathname(__FILE__).realpath + "../../Gemfile"
gemfile = [default, relative_to_binstub].detect(&:exist?)

if gemfile && !ENV["RUBYGEMS_GEMDEPS"]
  ENV["BUNDLE_GEMFILE"] = gemfile.to_s
  require "rubygems"
  require "bundler/setup"
else
  require "rubygems"
end

def wait_ignoring_interrupts(pid)
  Process.wait2(pid)[1].exitstatus
rescue Interrupt
  retry
rescue Errno::ECHILD
  1
end

guard_core_path = Gem.bin_path("guard", "_guard-core")
args = [guard_core_path] + ARGV
args.unshift(RbConfig.ruby) if Gem.win_platform?
loop do
  exitcode = wait_ignoring_interrupts(spawn(*args))
  exit(exitcode) if exitcode != 2
end
